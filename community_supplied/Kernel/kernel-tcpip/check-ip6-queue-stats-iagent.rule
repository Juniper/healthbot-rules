/*
 * This rule checks for the IP6 queue statistics in the system.
 *
 * It shows yellow alarm when the difference between packet queued and packet handled exceeds 95 percent of the queue size.
 * It shows red alarm if there is an increase in drop count.
 * It's sampling time is 30 seconds.
 */
healthbot { 
    topic kernel.tcpip {   
        rule check-ip6-queue-stats-iagent {
            synopsis "Check IPv6 queue statistics in the system";
            description "Rule to monitor IPv6 queue statistics in the system and report anomaly if it exceeds threshold";
            function pkt-queued-handled-abs {
                description "This returns an absolute value between queue and dequeue variable";
                path get_queued_handled_abs.py;
                method get_queued_handled_pkt_abs_value;
                argument pkt_handled_arg {
                    mandatory;
                }
                argument pkt_queued_arg {
                    mandatory;
                }
            }
            sensor kernel-tcpip-ip6-queue-stats-sensor {
                synopsis "Sensor to check IPv6 queue statistics in the system";
                description "Sensor to check IPv6 queue statistics in the system";
                iAgent {
                    file ip6_netisr_work.yml;
                    table ip6NetisrWorkTable;
                    frequency 30s;
                }
            }
            field ip6-drop-cnt-value {
                sensor kernel-tcpip-ip6-queue-stats-sensor {
                    path ip6_pkt_drop;
                }
                type integer;
                description "Drop packet count";
            }
            field ip6-pkt-handled-value {
                sensor kernel-tcpip-ip6-queue-stats-sensor {
                    path ip6_pkt_handled;
                }
                type integer;
                description "Packets handled";
            }
            field ip6-pkt-queued-value {
                sensor kernel-tcpip-ip6-queue-stats-sensor {
                    path ip6_pkt_queued;
                }
                type integer;
                description "Packets queued";
            }
            field pkt-queued-handled-abs-value {
                formula {
                    user-defined-function {
                        function-name pkt-queued-handled-abs;
                        argument pkt_queued_arg "$ip6-pkt-queued-value";
                        argument pkt_handled_arg "$ip6-pkt-handled-value";
                    }
                }
                type integer;
        }
            trigger report-ip6-queue-stats-iagent {
            synopsis "IPv6 queue statistics analyser in the system";
            description "To monitor IPv6 queue statistics in the system and report anomaly if it exceeds threshold size";
            frequency 1.5o;
            term ip6-queue-stats-abnormal {
                when {
                    not-equal-to "$ip6-drop-cnt-value" 0;
                    increasing-at-least-by-value "$ip6-drop-cnt-value" {
                        value 1;
                        time-range 3.5o;
                    }
                }
                then {
                    status {
                        color red;
                        message "Status abnormal: IPv6 max queue size is 3000 and current packet drop:$ip6-drop-cnt-value packet handled:$ip6-pkt-handled-value packet queued:$ip6-pkt-queued-value and current packets in queue:$pkt-queued-handled-abs-value";
                    }
                }
            }
            term ip6-queue-stats-normal {
                when {
                    greater-than "$pkt-queued-handled-abs-value" 2850;
                }
                then {
                    status {
                        color yellow;
                        message "Status normal: IPv6 max queue size is 3000 and current packet drop:$ip6-drop-cnt-value packet handled:$ip6-pkt-handled-value packet queued:$ip6-pkt-queued-value and current packets in queue:$pkt-queued-handled-abs-value";
                    }
                }
            }
            term default-term {
                then {
                    status {
                        color green;
                        message "Status normal: IPv6 max queue size is 3000 and current packet drop:$ip6-drop-cnt-value packet handled:$ip6-pkt-handled-value packet queued:$ip6-pkt-queued-value and current packets in queue:$pkt-queued-handled-abs-value";
                    }
                }
            }
        }
        rule-properties {
                version 1;
                contributor juniper;
                supported-healthbot-version 1.0.1;
                supported-devices {
                    juniper {
                        operating-system junos {
                            products EX {
                                releases 19.1R1 {
                                    release-support min-supported-release;
                                    platform [ EX9200 EX9251 EX9253 ];
                                }
                            }
                            products MX {
                                releases 19.1R1 {
                                       release-support min-supported-release;
                                        platform [ MX2010 MX2020 MX240 MX480 MX960 VMX ];
                                    }
                                }
                            products PTX {
                                releases 19.1R1 {
                                    release-support min-supported-release;
                                    platform PTX-Series-All;
                                }
                            }
                        }
                    }
                }
            }
        }
    }
}
