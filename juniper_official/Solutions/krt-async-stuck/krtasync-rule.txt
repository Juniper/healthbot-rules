iceberg {
    topic krt-async-status-check {
        rule krt-all {
            rule-frequency 1m;
            field krt-tree-current-count {
                reference {
                    path "/topic[topic-name=krt-async-status-check]/rule[rule-name=krtcorrtable]/krt-tree-current-count";
                }
            }
            field krt-tree-delete-count {
                reference {
                    path "/topic[topic-name=krt-async-status-check]/rule[rule-name=krtcorrtable]/krt-tree-delete-count";
                }
            }
            field krt-tree-insert-count {
                reference {
                    path "/topic[topic-name=krt-async-status-check]/rule[rule-name=krtcorrtable]/krt-tree-insert-count";
                }
            }
            field krtq-async-count {
                reference {
                    path "/topic[topic-name=krt-async-status-check]/rule[rule-name=krtstate]/krtq-async-count";
                }
            }
            field krtq-operations-queued {
                reference {
                    path "/topic[topic-name=krt-async-status-check]/rule[rule-name=krtstate]/krtq-operations-queued";
                }
            }
            field write-count {
                reference {
                    path "/topic[topic-name=krt-async-status-check]/rule[rule-name=krtiotable]/krt-io-write-count";
                }
            }
            trigger krt-stuck-1 {
                term is-krt-write-count-different {
                    when {
                        increasing-at-least-by-value "$write-count" {
                            value 1;
                        }
                    }
                    then {
                        status {
                            color green;
                            message "krt not stuck";
                        }
                    }
                }
                term is-krt-async-count-non-zero {
                    when {
                        not-equal-to "$krtq-async-count" 0;
                        increasing-at-most-by-value "$krtq-async-count" {
                            value 0;
                        }
                    }
                    then {
                        status {
                            color red;
                            message "krt stuck!!!";
                        }
                    }
                }
                term is-krtq-operations-queued-non-zero {
                    when {
                        not-equal-to "$krtq-operations-queued" 0;
                        increasing-at-most-by-value "$krtq-operations-queued" {
                            value 0;
                        }
                    }
                    then {
                        status {
                            color red;
                            message "krt stuck!!!";
                        }
                    }
                }
                term krtq-not-stuck {
                    then {
                        status {
                            color green;
                            message "krt not stuck";
                        }
                    }
                }
            }
            trigger krt-stuck-2 {
                term is-krt-tree-insert-count-greater {
                    when {
                        greater-than "$krt-tree-insert-count" "$krt-tree-delete-count";
                        increasing-at-most-by-value "$krt-tree-delete-count" {
                            value 0;
                        }
                    }
                    then {
                        status {
                            color red;
                            message "krt stuck!!!";
                        }
                    }
                }
                term krt-not-stuck {
                    then {
                        status {
                            color green;
                            message "krt not stuck";
                        }
                    }
                }
            }
            trigger krt-stuck-3 {
                term is-krt-stuck {
                    when {
                        range "$krt-tree-current-count" {
                            min 1;
                            max 20000;
                            time-range 1m;
                        }
                        range "$krtq-async-count" {
                            min 1;
                            max 20000;
                            time-range 1m;
                        }
                        increasing-at-least-by-value "$krt-tree-current-count" {
                            value 0;
                        }
                        increasing-at-least-by-value "$krtq-async-count" {
                            value 0;
                        }
                    }
                    then {
                        status {
                            color red;
                            message "krt stuck!!!";
                        }
                    }
                }
                term krt-not-stuck {
                    then {
                        status {
                            color green;
                            message "krt not stuck";
                        }
                    }
                }
            }
        }
        rule krtcorrtable {
            sensor krtcorrtable {
                iAgent {
                    file krtcorrtable.yml;
                    table krtcorrtable;
                    frequency 30s;
                }
            }
            field krt-tree-current-count {
                sensor krtcorrtable {
                    path current-count;
                }
            }
            field krt-tree-delete-count {
                sensor krtcorrtable {
                    path delete-count;
                }
            }
            field krt-tree-insert-count {
                sensor krtcorrtable {
                    path insert-count;
                }
            }
        }
        rule krtiotable {
            sensor krtiotable {
                iAgent {
                    file krtiotable.yml;
                    table krtiotable;
                    frequency 30s;
                }
            }
            field krt-io-write-count {
                sensor krtiotable {
                    path write-count;
                }
            }
        }
        rule krtstate {
            sensor krtstate {
                iAgent {
                    file krtstate.yml;
                    table krtstate;
                    frequency 30s;
                }
            }
            field krtq-async-count {
                sensor krtstate {
                    path Krt-Async-Count;
                }
            }
            field krtq-operations-queued {
                sensor krtstate {
                    path Krt-Operations-Queued;
                }
            }
        }
    }

    device mx960 {
        host 10.85.248.12;
        authentication {
            password {
                username labroot;
                password "$9$dCVYoJZjkqfoaFnCA0O"; ## SECRET-DATA
            }
        }
    }
    device-group KrtAsync {
        devices mx960;
        playbooks krtasyncstatuscheck;
        variable set1 krtasyncstatuscheck krt-async-status-check/krt-all;
        variable set1 krtasyncstatuscheck krt-async-status-check/krtcorrtable;
        variable set1 krtasyncstatuscheck krt-async-status-check/krtstate;
        variable set1 krtasyncstatuscheck krt-async-status-check/krtiotable;
    }
    system-settings {
        persist-raw-data; ## Warning: 'persist-raw-data' is deprecated
    }
}
