##Last changed: 2018-05-10 12:11:15 UTC
iceberg:iceberg {
    topic system_cpu {
        description "This topic is for monitoring the load average of cpu utilization over 1min, 5min, 15min";
        rule load_average {
            keys slot;
            function subtract {
                path system_sensors.py;
                method subtract;
                argument a {
                    mandatory;
                }
                argument b {
                    mandatory;
                }
            }
            sensor CPUutilizationTable {
                iAgent {
                    file cpu.yml;
                    table CPUutilizationTable;
                    frequency 10s;
                }
            }
            field cpu_utilization_15min_higher_threshold {
                formula {
                    user-defined-function {
                        function-name subtract;
                        argument a 100;
                        argument b "{{cpu_utilization_15min_higher_threshold}}";
                    }
                }
                type integer;
            }
            field cpu_utilization_15min_lower_threshold {
                formula {
                    user-defined-function {
                        function-name subtract;
                        argument a 100;
                        argument b "{{cpu_utilization_15min_lower_threshold}}";
                    }
                }
                type integer;
            }
            field cpu_utilization_1min_higher_threshold {
                formula {
                    user-defined-function {
                        function-name subtract;
                        argument a 100;
                        argument b "{{cpu_utilization_1min_higher_threshold}}";
                    }
                }
                type integer;
            }
            field cpu_utilization_1min_lower_threshold {
                formula {
                    user-defined-function {
                        function-name subtract;
                        argument a 100;
                        argument b "{{cpu_utilization_1min_lower_threshold}}";
                    }
                }
                type integer;
            }
            field cpu_utilization_5min_higher_threshold {
                formula {
                    user-defined-function {
                        function-name subtract;
                        argument a 100;
                        argument b "{{cpu_utilization_5min_higher_threshold}}";
                    }
                }
                type integer;
            }
            field cpu_utilization_5min_lower_threshold {
                formula {
                    user-defined-function {
                        function-name subtract;
                        argument a 100;
                        argument b "{{cpu_utilization_5min_lower_threshold}}";
                    }
                }
                type integer;
            }
            trigger cpu-utilization-15min {
                term green {
                    when {
                        greater-than-or-equal-to "$cpu-idle-15min" "$cpu_utilization_15min_lower_threshold";
                    }
                    then {
                        status {
                            color green;
                            message "15min-cpu-utilization lesser than lower threshold";
                        }
                    }
                }
                term yellow {
                    when {
                        greater-than-or-equal-to "$cpu-idle-15min" "$cpu_utilization_15min_higher_threshold";
                    }
                    then {
                        status {
                            color yellow;
                            message "15min-cpu-utilization is medium";
                        }
                    }
                }
                term red {
                    then {
                        status {
                            color red;
                            message "15min-cpu-utilization is greater than higher threshold";
                        }
                    }
                }
            }
            trigger cpu-utilization-1min {
                term green {
                    when {
                        greater-than-or-equal-to "$cpu-idle-1min" "$cpu_utilization_1min_lower_threshold";
                    }
                    then {
                        status {
                            color green;
                            message "1min cpu utilization is lesser than lower threshold";
                        }
                    }
                }
                term yellow {
                    when {
                        greater-than-or-equal-to "$cpu-idle-1min" "$cpu_utilization_1min_higher_threshold";
                    }
                    then {
                        status {
                            color yellow;
                            message "1min cpu utilization is medium ";
                        }
                    }
                }
                term red {
                    then {
                        status {
                            color red;
                            message "1min cpu utilization is greater than higher threshold";
                        }
                    }
                }
            }
            trigger cpu-utilization-5min {
                term green {
                    when {
                        greater-than "$cpu-idle-5min" "$cpu_utilization_5min_lower_threshold";
                    }
                    then {
                        status {
                            color green;
                            message "_5min-cpu-utilization is lesses than lower threshold";
                        }
                    }
                }
                term yellow {
                    when {
                        greater-than "$cpu-idle-5min" "$cpu_utilization_5min_higher_threshold";
                    }
                    then {
                        status {
                            color yellow;
                            message "5min-cpu-utilization is medium";
                        }
                    }
                }
                term red {
                    then {
                        status {
                            color red;
                            message "5min-cpu-utilization is greater than higher threshold";
                        }
                    }
                }
            }
            variable cpu_utilization_15min_higher_threshold {
                value 75;
                type int;
            }
            variable cpu_utilization_15min_lower_threshold {
                value 25;
                type int;
            }
            variable cpu_utilization_1min_higher_threshold {
                value 80;
                type int;
            }
            variable cpu_utilization_1min_lower_threshold {
                value 40;
                type int;
            }
            variable cpu_utilization_5min_higher_threshold {
                value 75;
                type int;
            }
            variable cpu_utilization_5min_lower_threshold {
                value 25;
                type int;
            }
        }
    }
    playbook system-cpu-playbook {
        rules system_cpu/load_average;
        synopsis "This playbook is for monitoring the load average of cpu utilization over 1min, 5min, 15min";
    }
}
