##Last changed: 2018-05-10 12:13:04 UTC
iceberg:iceberg {
    topic system_memory {
        description "This topic is for monitoring system buffer memory utilization";
        rule buffer {
            keys [ memory_property route_engine ];
            sensor components {
                open-config {
                    sensor-name /components/;
                    frequency 20s;
                }
            }
            field memory_buffer_higher_threshold {
                constant {
                    value "{{memory_buffer_higher_threshold}}";
                }
                type integer;
            }
            field memory_buffer_lower_threshold {
                constant {
                    value "{{memory_buffer_lower_threshold}}";
                }
                type integer;
            }
            field memory_property {
                sensor components {
                    where "/components/component/properties/property/@name =~ /{{memory_property_expr}}/";
                    path "/components/component/properties/property/@name";
                }
                type string;
            }
            field memory_property_value {
                sensor components {
                    where "/components/component/properties/property/@name =~ /{{memory_property_expr}}/";
                    path /components/component/properties/property/state/value;
                }
                type integer;
            }
            field route_engine {
                sensor components {
                    where "/components/component/@name =~ /{{route_engine}}/";
                    path "/components/component/@name";
                }
                type string;
            }
            trigger buffer_utilization {
                term skip {
                    when {
                        does-not-match-with "$memory_property" memory-utilization-buffer;
                    }
                }
                term green {
                    when {
                        less-than-or-equal-to "$memory_property_value" "$memory_buffer_lower_threshold";
                    }
                    then {
                        status {
                            color green;
                            message "operating_buffer is lesser than lower threshold i.e ($memory_property_value <= $memory_buffer_lower_threshold)";
                        }
                    }
                }
                term yellow {
                    when {
                        less-than-or-equal-to "$memory_property_value" "$memory_buffer_higher_threshold";
                    }
                    then {
                        status {
                            color yellow;
                            message "operating_buffer is medium i.e ($memory_buffer_lower_threshold <= $memory_property_value <= $memory_buffer_higher_threshold)";
                        }
                    }
                }
                term red {
                    then {
                        status {
                            color red;
                            message "operating_buffer is greater than higher threshold i.e ($memory_property_value > $memory_buffer_higher_threshold)";
                        }
                    }
                }
            }
            variable memory_buffer_higher_threshold {
                value 60;
                type int;
            }
            variable memory_buffer_lower_threshold {
                value 20;
                type int;
            }
            variable memory_property_expr {
                value memory-utilization-buffer;
                type string;
            }
            variable route_engine {
                value "^Routing Engine[0-1]*$";
                type string;
            }
        }
    }
    playbook system-memory-playbook {
        rules system_memory/buffer;
        synopsis "Playbook for monitoring system buffer memory utilization";
    }
}
