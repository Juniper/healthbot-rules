##Last changed: 2018-05-10 12:15:46 UTC
iceberg:iceberg {
    topic processes {
        description "This topic is for monitoring the cpu, memory utilization values associated with system processes";
        rule cpu {
            keys cmd;
            sensor SystemProcExtTable {
                iAgent {
                    file SystemProcExt.yml;
                    table SystemProcExtTable;
                    frequency 10s;
                }
            }
            field cmd {
                sensor SystemProcExtTable {
                    path cmd;
                }
                description "This field shows all processes being monitored";
            }
            field t1 {
                constant {
                    value "{{min_threshold}}";
                }
                type integer;
            }
            field t2 {
                constant {
                    value "{{max_threshold}}";
                }
                type integer;
            }
            field wcpu {
                sensor SystemProcExtTable {
                    path wcpu;
                }
                description "This field shows cpu utilization for corresponding processes";
            }
            trigger chassisd {
                frequency 10s;
                term skip {
                    when {
                        does-not-match-with "$cmd" chassisd;
                    }
                }
                term green {
                    when {
                        less-than-or-equal-to "$wcpu" "$t1";
                    }
                    then {
                        status {
                            color green;
                            message "cpu utilization for chassisd is below lower threshold.";
                        }
                    }
                }
                term yellow {
                    when {
                        less-than-or-equal-to "$wcpu" "$t2";
                    }
                    then {
                        status {
                            color yellow;
                            message "cpu utilization for chassisd is medium.";
                        }
                    }
                }
                term red {
                    then {
                        status {
                            color red;
                            message "cpu utilization for chassisd is above higher threshold.";
                        }
                    }
                }
            }
            trigger cosd {
                frequency 60s;
                term skip {
                    when {
                        does-not-match-with "$cmd" cosd;
                    }
                }
                term green {
                    when {
                        less-than-or-equal-to "$wcpu" "$t1";
                    }
                    then {
                        status {
                            color green;
                            message "cpu utilization for cosd is below lower threshold.";
                        }
                    }
                }
                term yellow {
                    when {
                        less-than-or-equal-to "$wcpu" "$t2";
                    }
                    then {
                        status {
                            color yellow;
                            message "cpu utilization for cosd is medium.";
                        }
                    }
                }
                term red {
                    then {
                        status {
                            color red;
                            message "cpu utilization for cosd is above threshold.";
                        }
                    }
                }
            }
            trigger dcd {
                frequency 60s;
                term skip {
                    when {
                        does-not-match-with "$cmd" dcd;
                    }
                }
                term green {
                    when {
                        less-than-or-equal-to "$wcpu" "$t1";
                    }
                    then {
                        status {
                            color green;
                            message "cpu utilization for dcd is below lower threshold.";
                        }
                    }
                }
                term yellow {
                    when {
                        less-than-or-equal-to "$wcpu" "$t2";
                    }
                    then {
                        status {
                            color yellow;
                            message "cpu utilization for dcd is medium.";
                        }
                    }
                }
                term red {
                    then {
                        status {
                            color red;
                            message "cpu utilization for dcd is above higher threshold.";
                        }
                    }
                }
            }
            trigger dfwd {
                frequency 60s;
                term skip {
                    when {
                        does-not-match-with "$cmd" dfwd;
                    }
                }
                term green {
                    when {
                        less-than-or-equal-to "$wcpu" "$t1";
                    }
                    then {
                        status {
                            color green;
                            message "cpu utilization for dfwd is below lower threshold.";
                        }
                    }
                }
                term yellow {
                    when {
                        less-than-or-equal-to "$wcpu" "$t2";
                    }
                    then {
                        status {
                            color yellow;
                            message "cpu utilization for dfwd is medium.";
                        }
                    }
                }
                term red {
                    then {
                        status {
                            color red;
                            message "cpu utilization for dfwd is above higher threshold.";
                        }
                    }
                }
            }
            trigger eventd {
                frequency 60s;
                term skip {
                    when {
                        does-not-match-with "$cmd" eventd;
                    }
                }
                term green {
                    when {
                        less-than-or-equal-to "$wcpu" "$t1";
                    }
                    then {
                        status {
                            color green;
                            message "cpu utilization for eventd is below lower threshold.";
                        }
                    }
                }
                term yellow {
                    when {
                        less-than-or-equal-to "$wcpu" "$t2";
                    }
                    then {
                        status {
                            color yellow;
                            message "cpu utilization for eventd is medium.";
                        }
                    }
                }
                term red {
                    then {
                        status {
                            color red;
                            message "cpu utilization for eventd is above higher threshold.";
                        }
                    }
                }
            }
            trigger mgd {
                frequency 60s;
                term skip {
                    when {
                        does-not-match-with "$cmd" mgd;
                    }
                }
                term green {
                    when {
                        less-than-or-equal-to "$wcpu" "$t1";
                    }
                    then {
                        status {
                            color green;
                            message "cpu utilization for mgd is below lower threshold.";
                        }
                    }
                }
                term yellow {
                    when {
                        less-than-or-equal-to "$wcpu" "$t2";
                    }
                    then {
                        status {
                            color yellow;
                            message "cpu utilization for mgd is medium.";
                        }
                    }
                }
                term red {
                    then {
                        status {
                            color red;
                            message "cpu utilization for mgd is above higher threshold.";
                        }
                    }
                }
            }
            trigger mib2d {
                frequency 60s;
                term skip {
                    when {
                        does-not-match-with "$cmd" mib2d;
                    }
                }
                term green {
                    when {
                        less-than-or-equal-to "$wcpu" "$t1";
                    }
                    then {
                        status {
                            color green;
                            message "cpu utilization for mib2d is below lower threshold.";
                        }
                    }
                }
                term yellow {
                    when {
                        less-than-or-equal-to "$wcpu" "$t2";
                    }
                    then {
                        status {
                            color yellow;
                            message "cpu utilization for mib2d is medium.";
                        }
                    }
                }
                term red {
                    then {
                        status {
                            color red;
                            message "cpu utilization for mib2d is above higher threshold.";
                        }
                    }
                }
            }
            trigger pfed {
                frequency 60s;
                term skip {
                    when {
                        does-not-match-with "$cmd" pfed;
                    }
                }
                term green {
                    when {
                        less-than-or-equal-to "$wcpu" "$t1";
                    }
                    then {
                        status {
                            color green;
                            message "cpu utilization for pfed is below lower threshold.";
                        }
                    }
                }
                term yellow {
                    when {
                        less-than-or-equal-to "$wcpu" "$t2";
                    }
                    then {
                        status {
                            color yellow;
                            message "cpu utilization for pfed is medium.";
                        }
                    }
                }
                term red {
                    then {
                        status {
                            color red;
                            message "cpu utilization for pfed is above higher threshold.";
                        }
                    }
                }
            }
            trigger rpd {
                frequency 60s;
                term skip {
                    when {
                        does-not-match-with "$cmd" rpd;
                    }
                }
                term green {
                    when {
                        less-than-or-equal-to "$wcpu" "$t1";
                    }
                    then {
                        status {
                            color green;
                            message "cpu utilization for rpd is below lower threshold.";
                        }
                    }
                }
                term yellow {
                    when {
                        less-than-or-equal-to "$wcpu" "$t2";
                    }
                    then {
                        status {
                            color yellow;
                            message "cpu utilization for rpd is medium.";
                        }
                    }
                }
                term red {
                    then {
                        status {
                            color red;
                            message "cpu utilization for rpd is above higher threshold.";
                        }
                    }
                }
            }
            trigger snmpd {
                frequency 60s;
                term skip {
                    when {
                        does-not-match-with "$cmd" snmpd;
                    }
                }
                term green {
                    when {
                        less-than-or-equal-to "$wcpu" "$t1";
                    }
                    then {
                        status {
                            color green;
                            message "cpu utilization for snmpd is below lower threshold.";
                        }
                    }
                }
                term yellow {
                    when {
                        less-than-or-equal-to "$wcpu" "$t2";
                    }
                    then {
                        status {
                            color yellow;
                            message "cpu utilization for snmpd is medium";
                        }
                    }
                }
                term red {
                    then {
                        status {
                            color red;
                            message "cpu utilization for snmpd is above higher threshold";
                        }
                    }
                }
            }
            variable max_threshold {
                value 70;
                type int;
            }
            variable min_threshold {
                value 20;
                type int;
            }
        }
        rule memory {
            keys cmd;
            function isExceeding {
                path system_processes.py;
                method isExceeding;
                argument res {
                    mandatory;
                }
                argument size {
                    mandatory;
                }
                argument threshold {
                    mandatory;
                }
            }
            sensor ProcessMemory {
                iAgent {
                    file ProcessMemory.yml;
                    table ProcessMemoryTable;
                    frequency 10s;
                }
            }
            field cmd {
                sensor ProcessMemory {
                    path cmd;
                }
            }
            field reserved {
                sensor ProcessMemory {
                    path res;
                }
            }
            field size {
                sensor ProcessMemory {
                    path size;
                }
            }
            field t1 {
                constant {
                    value "{{min_threshold}}";
                }
                type integer;
            }
            field t2 {
                constant {
                    value "{{max_threshold}}";
                }
                type integer;
            }
            field wcpu {
                sensor ProcessMemory {
                    path wcpu;
                }
            }
            trigger chassisd {
                frequency 10s;
                term skip {
                    when {
                        does-not-match-with "$cmd" chassisd;
                    }
                }
                term green {
                    when {
                        user-defined-function isExceeding {
                            argument size "$size";
                            argument res "$reserved";
                            argument threshold "$t1";
                        }
                    }
                    then {
                        status {
                            color green;
                            message "chassisd memory utilization is below lower threshold";
                        }
                    }
                }
                term yellow {
                    when {
                        user-defined-function isExceeding {
                            argument size "$size";
                            argument res "$reserved";
                            argument threshold "$t2";
                        }
                    }
                    then {
                        status {
                            color yellow;
                            message "chassisd memory utilization is medium";
                        }
                    }
                }
                term red {
                    then {
                        status {
                            color red;
                            message "chassisd memory utilization is above threshold";
                        }
                    }
                }
            }
            trigger cosd {
                frequency 10s;
                term skip {
                    when {
                        does-not-match-with "$cmd" cosd;
                    }
                }
                term green {
                    when {
                        user-defined-function isExceeding {
                            argument size "$size";
                            argument res "$reserved";
                            argument threshold "$t1";
                        }
                    }
                    then {
                        status {
                            color green;
                            message "cosd memory utilization is below lower threshold";
                        }
                    }
                }
                term yellow {
                    when {
                        user-defined-function isExceeding {
                            argument size "$size";
                            argument res "$reserved";
                            argument threshold "$t2";
                        }
                    }
                    then {
                        status {
                            color yellow;
                            message "cosd memory utilization is medium";
                        }
                    }
                }
                term red {
                    then {
                        status {
                            color red;
                            message "cosd memory utilization is above threshold";
                        }
                    }
                }
            }
            trigger dcd {
                frequency 10s;
                term skip {
                    when {
                        does-not-match-with "$cmd" dcd;
                    }
                }
                term green {
                    when {
                        user-defined-function isExceeding {
                            argument size "$size";
                            argument res "$reserved";
                            argument threshold "$t1";
                        }
                    }
                    then {
                        status {
                            color green;
                            message "dcd memory utilization is below lower threshold";
                        }
                    }
                }
                term yellow {
                    when {
                        user-defined-function isExceeding {
                            argument size "$size";
                            argument res "$reserved";
                            argument threshold "$t2";
                        }
                    }
                    then {
                        status {
                            color yellow;
                            message "dcd memory utilization is medium";
                        }
                    }
                }
                term red {
                    then {
                        status {
                            color red;
                            message "dcd memory utilization is above threshold";
                        }
                    }
                }
            }
            trigger dfwd {
                frequency 10s;
                term skip {
                    when {
                        does-not-match-with "$cmd" dfwd;
                    }
                }
                term green {
                    when {
                        user-defined-function isExceeding {
                            argument size "$size";
                            argument res "$reserved";
                            argument threshold "$t1";
                        }
                    }
                    then {
                        status {
                            color green;
                            message "dfwd memory utilization is below lower threshold";
                        }
                    }
                }
                term yellow {
                    when {
                        user-defined-function isExceeding {
                            argument size "$size";
                            argument res "$reserved";
                            argument threshold "$t2";
                        }
                    }
                    then {
                        status {
                            color yellow;
                            message "dfwd memory utilization is medium";
                        }
                    }
                }
                term red {
                    then {
                        status {
                            color red;
                            message "dfwd memory utilization is above threshold";
                        }
                    }
                }
            }
            trigger eventd {
                frequency 10s;
                term skip {
                    when {
                        does-not-match-with "$cmd" eventd;
                    }
                }
                term green {
                    when {
                        user-defined-function isExceeding {
                            argument size "$size";
                            argument res "$reserved";
                            argument threshold "$t1";
                        }
                    }
                    then {
                        status {
                            color green;
                            message "eventd memory utilization is below lower threshold";
                        }
                    }
                }
                term yellow {
                    when {
                        user-defined-function isExceeding {
                            argument size "$size";
                            argument res "$reserved";
                            argument threshold "$t2";
                        }
                    }
                    then {
                        status {
                            color yellow;
                            message "eventd memory utilization is medium";
                        }
                    }
                }
                term red {
                    then {
                        status {
                            color red;
                            message "eventd memory utilization is above threshold";
                        }
                    }
                }
            }
            trigger mgd {
                frequency 10s;
                term skip {
                    when {
                        does-not-match-with "$cmd" mgd;
                    }
                }
                term green {
                    when {
                        user-defined-function isExceeding {
                            argument size "$size";
                            argument res "$reserved";
                            argument threshold "$t1";
                        }
                    }
                    then {
                        status {
                            color green;
                            message "mgd memory utilization is below lower threshold";
                        }
                    }
                }
                term yellow {
                    when {
                        user-defined-function isExceeding {
                            argument size "$size";
                            argument res "$reserved";
                            argument threshold "$t2";
                        }
                    }
                    then {
                        status {
                            color yellow;
                            message "mgd memory utilization is medium";
                        }
                    }
                }
                term red {
                    then {
                        status {
                            color red;
                            message "mgd memory utilization is above threshold";
                        }
                    }
                }
            }
            trigger mib2d {
                frequency 10s;
                term skip {
                    when {
                        does-not-match-with "$cmd" mib2d;
                    }
                }
                term green {
                    when {
                        user-defined-function isExceeding {
                            argument size "$size";
                            argument res "$reserved";
                            argument threshold "$t1";
                        }
                    }
                    then {
                        status {
                            color green;
                            message "mib2d memory utilization is below lower threshold";
                        }
                    }
                }
                term yellow {
                    when {
                        user-defined-function isExceeding {
                            argument size "$size";
                            argument res "$reserved";
                            argument threshold "$t2";
                        }
                    }
                    then {
                        status {
                            color yellow;
                            message "mib2d memory utilization is medium";
                        }
                    }
                }
                term red {
                    then {
                        status {
                            color red;
                            message "mib2d memory utilization is above threshold";
                        }
                    }
                }
            }
            trigger pfed {
                frequency 10s;
                term skip {
                    when {
                        does-not-match-with "$cmd" pfed;
                    }
                }
                term green {
                    when {
                        user-defined-function isExceeding {
                            argument size "$size";
                            argument res "$reserved";
                            argument threshold "$t1";
                        }
                    }
                    then {
                        status {
                            color green;
                            message "pfed memory utilization is below lower threshold";
                        }
                    }
                }
                term yellow {
                    when {
                        user-defined-function isExceeding {
                            argument size "$size";
                            argument res "$reserved";
                            argument threshold "$t2";
                        }
                    }
                    then {
                        status {
                            color yellow;
                            message "pfed memory utilization is medium";
                        }
                    }
                }
                term red {
                    then {
                        status {
                            color red;
                            message "pfed memory utilization is above threshold";
                        }
                    }
                }
            }
            trigger rpd {
                frequency 10s;
                term skip {
                    when {
                        does-not-match-with "$cmd" rpd;
                    }
                }
                term green {
                    when {
                        user-defined-function isExceeding {
                            argument size "$size";
                            argument res "$reserved";
                            argument threshold "$t1";
                        }
                    }
                    then {
                        status {
                            color green;
                            message "rpd memory utilization is below lower threshold";
                        }
                    }
                }
                term yellow {
                    when {
                        user-defined-function isExceeding {
                            argument size "$size";
                            argument res "$reserved";
                            argument threshold "$t2";
                        }
                    }
                    then {
                        status {
                            color yellow;
                            message "rpd memory utilization is medium";
                        }
                    }
                }
                term red {
                    then {
                        status {
                            color red;
                            message "rpd memory utilization is above threshold";
                        }
                    }
                }
            }
            trigger snmpd {
                frequency 10s;
                term skip {
                    when {
                        does-not-match-with "$cmd" snmpd;
                    }
                }
                term green {
                    when {
                        user-defined-function isExceeding {
                            argument size "$size";
                            argument res "$reserved";
                            argument threshold "$t1";
                        }
                    }
                    then {
                        status {
                            color green;
                            message "snmpd memory utilization is below lower threshold";
                        }
                    }
                }
                term yellow {
                    when {
                        user-defined-function isExceeding {
                            argument size "$size";
                            argument res "$reserved";
                            argument threshold "$t2";
                        }
                    }
                    then {
                        status {
                            color yellow;
                            message "snmpd memory utilization is medium";
                        }
                    }
                }
                term red {
                    then {
                        status {
                            color red;
                            message "snmpd memory utilization is above threshold";
                        }
                    }
                }
            }
            variable max_threshold {
                value 70;
                type int;
            }
            variable min_threshold {
                value 20;
                type int;
            }
        }
    }
    playbook processes-playbook {
        rules [ processes/cpu processes/memory ];
        description "This playbook takes min, max thresholds as input and monitors cpu, memory utilization of system processes like chassisd, pfed, snmpd, etc.";
        synopsis "Playbook for monitoring processes(like chassisd, pfed, snmpd, etc) cpu and memory utilization";
    }
}
