/*
 *    Monitors fan state and RPM percentage and notifies when anomalies are found.
 *    2 Variables :
 *
 *   1) high-threshold, defaults to 80% 
 *
 *   2) low-threshold, defaults to 50%
 *      
 */
healthbot {
    topic hardware.chassis {
        rule check-fan-state-rpm {
            /*
             * Monitors fan state and RPM percentage and notifies via dashboard, red color 
             * when threshold is exceeded else green
			 *
             * Use fan-name as key for rule
             */		
            keys fan-name;
            synopsis "Chassis fans health analyzer";
            description "Collects chassis environment statistics periodically and notifies anomalies when fan status is NOK";
            /*
             * Sensor configuration to get data from network devices
             */			
            sensor fan-netconf {
                iAgent {
                    file fanEVOTable.yml;
                    table fanEVOTable;
                    frequency 180s;
                }
            }
            /*
             * Fields defined using sensor path. Map the longer sensor names
             * to the shorter field names used in the rules
             */			
            field fan-name {
                sensor fan-netconf {
                    path name;
                }
                type string;
                description "Name of the fan tray and fan number";
            }
            field measurements {
                sensor fan-netconf {
                    path measurement;
                    data-if-missing {
                        value 0;
                    }					
                }
                type string;
                description "RPM String Value";				
            }			
            field measurement {
                formula {
                    capture-groups {
                        field-name "$measurements";
                        pattern "\d+";
                    }
                }
                type integer;
                description "RPM Value";				
            }
            field rpm-percents {
                sensor fan-netconf {
                    path rpm;
                    data-if-missing {
                        value 0;
                    }
                }
                type string;
                description "RPM string percentage";
            }			
            field rpm-percent {
                formula {
                    capture-groups {
                        field-name "$rpm-percents";
                        pattern "\d+";
                    }
                }
                type integer;
                description "RPM percentage";
            }
            field rpm-percent-anomaly {
                formula {
                    jaiml-anomaly-detection {
                        field-name "$rpm-percent";
                    }
                }
                type integer;
                description "JAIML anomaly detection on rpm-percent field";
            }
            field status {
                sensor fan-netconf {
                    path status;
                }
                type string;
                description "Status of the fan";
            }
            field high-threshold {
                constant {
                    value "{{high-threshold}}";
                }
                type integer;
                description "RPM high threshold";
            }
            field low-threshold {
                constant {
                    value "{{low-threshold}}";
                }
                type integer;
                description "RPM low threshold";
            }
            field rpm-high-threshold {
                formula {
                    eval {
                        expression "$measurement * $high-threshold / $rpm-percent";
                    }
                }
                type float;
                description "RPM High threshold measurement";
            }
            field rpm-low-threshold {
                formula {
                    eval {
                        expression "$measurement * $low-threshold / $rpm-percent";
                    }
                }
                type float;
                description "RPM low threshold measurement";
            }
            field critical-rpm-threshold {
                formula {
                    eval {
                        expression "$measurement * $high-threshold / $rpm-percent";
                    }
                }
                type integer;
                description "RPM High threshold measurement";
            }
            field high-rpm-threshold {
                formula {
                    eval {
                        expression "$measurement * $low-threshold / $rpm-percent";
                    }
                }
                type integer;
                description "RPM low threshold measurement";
            }			
            /*
             * Anomaly detection logic
             */			
            trigger fan-state {
                synopsis "Fan State KPI";
                description "Sets health based on Fan state";			
                frequency 1offset;
                /*
                 * Sets color to green when status is ok.
                 * 
                 */				
                term state-is-ok {
                    when {
                        matches-with "$status" ok {
                            ignore-case;
                        }
                    }
                    then {
                        status {
                            color green;
                            message "$fan-name is in OK state";
                        }
                    }
                }
                /*
                 * Sets color to red when status is not ok
                 * 
                 */				
                term state-is-not-ok {
                    when {
                        does-not-match-with "$status" ok {
                            ignore-case;
                        }
                    }
                    then {
                        status {
                            color red;
                            message "$fan-name is not in OK state";
                        }
                    }
                }
            }
            trigger rpm-percent {
                synopsis "Fan RPM KPI";
                description "Sets health based on Fan RPM percentage";			
                frequency 1offset;
                /*
                 * Sets color to green when RPM is lesser than 50%.
                 * 
                 */				
                term normal {
                    when {
                        less-than "$rpm-percent" "$low-threshold";
                        less-than-or-equal-to "$rpm-percent-anomaly" 0;
                    }				
                    then {
                        status {
                            color green;
                            message "$fan-name RPM percent is $rpm-percent is normal";
                        }
                    }
                }
                /*
                 * Sets color to yellow when RPM is below low threshold ($low-threshold)
                 * and the RPM value is anomalous.
                 */ 				
                term is-rpm-percent-anomalous {
                    when {
                        less-than "$rpm-percent" "$low-threshold";
                        equal-to "$rpm-percent-anomaly" 1;
                    }
                    then {
                        status {
                            color yellow;
                            message "$fan-name RPM percent($rpm-percent%) is not between the predicted range of ($rpm-percent-anomaly-lower-boundary and $rpm-percent-anomaly-upper-boundary)";
                        }
                    }
                }
                /*
                 * Sets color to green when RPM is below low threshold ($low-threshold)
                 * 
                 */				
                term is-rpm-percent-less-than-low-threshold {
                    when {
                        less-than "$rpm-percent" "$low-threshold";
                    }
                    then {
                        status {
                            color green;
                            message "$fan-name RPM percent($rpm-percent) is normal";
                        }
                    }
                }				
                /*
                 * Sets color to yellow when RPM is more than or equal to 50%.
                 * 
                 */				
                term above-low-threshold {
                    when {
                        greater-than-or-equal-to "$rpm-percent" "$low-threshold";
                        less-than "$rpm-percent" "$high-threshold";
                    }				
                    then {
                        status {
                            color yellow;
                            message "$fan-name RPM percent $rpm-percent($measurement RPM) is greater than or equal to high threshold $high-rpm-threshold";
                        }
                    }
                }
                /*
                 * Sets color to red when RPM is more than 80%.
                 * 
                 */				
                term above-high-threshold {
                    when {
                        greater-than-or-equal-to "$rpm-percent" "$high-threshold";
                    }
                    then {
                        status {
                            color red;
                            message "$fan-name RPM percent $rpm-percent($measurement RPM) is greater than or equal to critical threshold $critical-rpm-threshold";
                        }
                    }
                }
            }				
            variable high-threshold {
                value 80;
                description "RPM high threshold";
                type int;
            }
            variable low-threshold {
                value 50;
                description "RPM low threshold";
                type int;
            }			
            rule-properties {
                version 1;
                contributor juniper;
                category basic;
                supported-healthbot-version 4.3.0;
                supported-devices {
                    juniper {
                        operating-system junosEvolved {
                            products ACX {
                                platforms All {
                                    releases 22.3R1 {
                                        release-support min-supported-release;
                                    }
                                }
                            }
                        }						
                    }
                }
                helper-files other {
                    list-of-files [ fanEVOTable.yml ];
                }				
            }
        }
    }
}	
	
		
		