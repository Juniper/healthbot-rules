/*
 * Detects PFE discards and notifies when anomalies are found.
 * One inputs control detection
 * 
 *   1) discard-count, is the threshold that causes the rule to report
 *      an anomaly.  By default it's 1. This rule will set a dashboard
 *      color to red when *all* the discards are greater than
 *      'discard-count' for 75s. otherwise color is set to green.
 */
healthbot {
    topic hardware.fpc {
        rule check-pfe-discards {
             /*
             * Monitors the pfe discards count on PFE. Notifies via the dashboard
             * colors when the flaps increase by {{discard-count}} for every collected
             * metric during a 75s time range (red). Otherwise the color is set to green
             * 
             */		
            synopsis "Packet forwarding engine hardware discard statistics analyzer";
            description "Collects packet forwarding engine hardware discard statistics and notifies when discard count increases";
            sensor pfe-sensor-netconf {
                synopsis "PFE discard KPI";
                description "Collects data from  network device netconf rpc using get-pfe-traffic-statistics";
                iAgent {
                    file evopfeDiscardStats.yml;
                    table pfeDiscardStats;
                    frequency 60s;
                }
            }
            /*
             * Fields defined using values in the yml file.
             * 
             */			
            field bad-route-discard {
                sensor pfe-sensor-netconf {
                    path bad-route-discard;
                }
                type integer;
                description "Bad route discard count";
            }
            field bits-to-test-discard {
                sensor pfe-sensor-netconf {
                    path bits-to-test-discard;
                }
                type integer;
                description "Bits to test discard count";
            }
            field data-error-discard {
                sensor pfe-sensor-netconf {
                    path data-error-discard;
                }
                type integer;
                description "Data error discard count";
            }
            field drop-threshold {
                constant {
                    value "{{discard-count}}";
                }
                type integer;
                description "Drop count increase threshold";
            }
            field fabric-discard {
                sensor pfe-sensor-netconf {
                    path fabric-discard;
                }
                type integer;
                description "Fabric discard count";
            }
            field info-cell-discard {
                sensor pfe-sensor-netconf {
                    path info-cell-discard;
                }
                type integer;
                description "Info cell discard count";
            }
            field invalid-iif-discard {
                sensor pfe-sensor-netconf {
                    path invalid-iif-discard;
                }
                type integer;
                description "Invalid IIF discard count";
            }
            field nexthop-discard {
                sensor pfe-sensor-netconf {
                    path nexthop-discard;
                }
                type integer;
                description "Nexthop discard count";
            }
            field stack-overflow-discard {
                sensor pfe-sensor-netconf {
                    path stack-overflow-discard;
                }
                type integer;
                description "Stack overflow discard count";
            }
            field stack-underflow-discard {
                sensor pfe-sensor-netconf {
                    path stack-underflow-discard;
                }
                type integer;
                description "Stack underflow discard count";
            }
            field tcp-header-error-discard {
                sensor pfe-sensor-netconf {
                    path tcp-header-error-discard;
                }
                type integer;
                description "TCP header error discard count";
            }
            field bad-route-discard-rate {
                formula {
                    rate-of-change {
                        field-name "$bad-route-discard";
                    }
                }
                type integer;
                description "Bad route discard rate.";
            }
            field bits-to-test-discard-rate {
                formula {
                    rate-of-change {
                        field-name "$bits-to-test-discard";
                    }
                }
                type integer;
                description "Bits to test discard rate.";
            }
            field data-error-discard-rate {
                formula {
                    rate-of-change {
                        field-name "$data-error-discard";
                    }
                }
                type integer;
                description "Data error discard rate";
            }
            field fabric-discard-rate {
                formula {
                    rate-of-change {
                        field-name "$fabric-discard";
                    }
                }
                type integer;
                description "Fabric discard rate";
            }
            field info-cell-discard-rate {
                formula {
                    rate-of-change {
                        field-name "$info-cell-discard";
                    }
                }
                type integer;
                description "Info cell discard rate";
            }
            field invalid-iif-discard-rate {
                formula {
                    rate-of-change {
                        field-name "$invalid-iif-discard";
                    }
                }
                type integer;
                description "Invalid IIF discard rate.";
            }
            field nexthop-discard-rate {
                formula {
                    rate-of-change {
                        field-name "$nexthop-discard";
                    }
                }
                type integer;
                description "Nexthop discard rate.";
            }
            field stack-overflow-discard-rate {
                formula {
                    rate-of-change {
                        field-name "$stack-overflow-discard";
                    }
                }
                type integer;
                description "Stack overflow discard rate.";
            }
            field stack-underflow-discard-rate {
                formula {
                    rate-of-change {
                        field-name "$stack-underflow-discard";
                    }
                }
                type integer;
                description "Stack underflow discard rate";
            }
            field tcp-header-error-discard-rate {
                formula {
                    rate-of-change {
                        field-name "$tcp-header-error-discard";
                    }
                }
                type integer;
                description "TCP header error discard rate.";
            }
            /*
            * Anomaly detection logic.
            */			
            trigger pfe-data-error-discard {
                synopsis "PFE data error discards KPI";
                description "Sets health based on the change in PFE data error discard count";
                frequency 1.25offset;
                /*
                 * Sets color to green when data-error-discard is same as previous value.
                 */				
                term no-data-error-discard {
                    when {
                        matches-with-previous "$data-error-discard";
                    }
                    then {
                        status {
                            color green;
                            message "Data-error-discard count $data-error-discard";
                        }
                    }
                }
                /*
                 * Sets color to red when data-error-discard is increasing-at-least-by-value drop-threshold.
                 */				
                term is-data-error-discard {
                    when {
                        increasing-at-least-by-value "$data-error-discard" {
                            value "$drop-threshold";
                        }
                    }
                    then {
                        status {
                            color red;
                            message "Increasing data-error-discard count $data-error-discard at the rate $data-error-discard-rate per minute ";
                        }
                    }
                }
            }
            trigger pfe-bad-route-discard {
                synopsis "PFE bad route discards KPI";
                description "Sets health based on the change in PFE bad route discard count";
                frequency 1.25offset;
                /*
                 * Sets color to green when bad-route-discard is same as previous value.
                 */				
                term no-bad-route-discard {
                    when {
                        matches-with-previous "$bad-route-discard";
                    }
                    then {
                        status {
                            color green;
                            message "bad-route-discard count $bad-route-discard";
                        }
                    }
                }
                /*
                 * Sets color to red when bad-route-discard is increasing-at-least-by-value drop-threshold.
                 */				
                term is-bad-route-discard {
                    when {
                        increasing-at-least-by-value "$bad-route-discard" {
                            value "$drop-threshold";
                        }
                    }
                    then {
                        status {
                            color red;
                            message "Increasing bad-route-discard drop count $bad-route-discard at the rate $bad-route-discard-rate per minute";
                        }
                    }
                }
            }
            trigger pfe-bits-to-test-discard {
                synopsis "PFE bits to test discards KPI";
                description "Sets health based on the change in PFE bits to test discard count";
                frequency 1.25offset;
                /*
                 * Sets color to green when bits-to-test-discard is same as previous value.
                 */
                term no-bits-to-test-discard {
                    when {
                        matches-with-previous "$bits-to-test-discard";
                    }				
                    then {
                        status {
                            color green;
                            message "Bits-to-test-discard count $bits-to-test-discard";
                        }
                    }
                }				 
                /*
                 * Sets color to red when bits-to-test-discard is increasing-at-least-by-value drop-threshold.
                 */				
                term is-bits-to-test-discard {
                    when {
                        increasing-at-least-by-value "$bits-to-test-discard" {
                            value "$drop-threshold";
                        }
                    }
                    then {
                        status {
                            color red;
                            message "Increasing bits-to-test-discard drop count $bits-to-test-discard at the rate $bits-to-test-discard-rate per minute";
                        }
                    }
                }
            }
            trigger pfe-fabric-discards {
                synopsis "PFE fabric discards KPI";
                description "Sets health based on the change in PFE fabric discard count";
                frequency 1.25offset;
                /*
                 * Sets color to green when fabric-discard is same as previous value.
                 */
                term no-fabric-drop {
                    when {
                        matches-with-previous "$fabric-discard";
                    }				
                    then {
                        status {
                            color green;
                            message "Fabric drop count $fabric-discard";
                        }
                    }
                }				 
                /*
                 * Sets color to red when fabric-discard is increasing-at-least-by-value drop-threshold.
                 */				
                term is-fabric-drop {
                    when {
                        increasing-at-least-by-value "$fabric-discard" {
                            value "$drop-threshold";
                        }
                    }
                    then {
                        status {
                            color red;
                            message "Increasing fabric drop count $fabric-discard at the rate $fabric-discard-rate per minute.";
                        }
                    }
                }
            }
            trigger pfe-info-cell-discard {
                synopsis "PFE info cell discards KPI";
                description "Sets health based on the change in PFE info cell discard count";
                frequency 1.25offset;
                /*
                 * Sets color to green when info-cell-discard is same as previous value.
                 */
                term no-info-cell-discard {
                    when {
                        matches-with-previous "$info-cell-discard";
                    }				
                    then {
                        status {
                            color green;
                            message "info-cell-discard count $info-cell-discard";
                        }
                    }
                }				 
                /*
                 * Sets color to red when info-cell-discard is increasing-at-least-by-value drop-threshold.
                 */				
                term is-info-cell-discard {
                    when {
                        increasing-at-least-by-value "$info-cell-discard" {
                            value "$drop-threshold";
                        }
                    }
                    then {
                        status {
                            color red;
                            message "Increasing info-cell-discard drop count $info-cell-discard at the rate $info-cell-discard-rate per minute";
                        }
                    }
                }
            }
            trigger pfe-invalid-iif-discard {
                synopsis "PFE invalid IIF discards KPI";
                description "Sets health based on the change in PFE invalid IIF discard count";
                frequency 1.25offset;
                /*
                 * Sets color to green when invalid-iif-discard is same as previous value.
                 */
                term no-invalid-iif-discard {
                    when {
                        matches-with-previous "$invalid-iif-discard";
                    }				
                    then {
                        status {
                            color green;
                            message "invalid-iif-discard count $invalid-iif-discard";
                        }
                    }
                }				 
                /*
                 * Sets color to red when invalid-iif-discard is increasing-at-least-by-value drop-threshold.
                 */				
                term is-invalid-iif-discard {
                    when {
                        increasing-at-least-by-value "$invalid-iif-discard" {
                            value "$drop-threshold";
                        }
                    }
                    then {
                        status {
                            color red;
                            message "Increasing invalid-iif-discard drop count $invalid-iif-discard at the rate $invalid-iif-discard-rate per minute";
                        }
                    }
                }
            }
            trigger pfe-nexthop-discard {
                synopsis "PFE nexthop discards KPI";
                description "Sets health based on the change in PFE nexthop discard count";
                frequency 1.25offset;
                /*
                 * Sets color to green when nexthop-discard is same as previous value.
                 */
                term no-nexthop-discard {
                    when {
                        matches-with-previous "$nexthop-discard";
                    }				
                    then {
                        status {
                            color green;
                            message "nexthop-discard count $nexthop-discard";
                        }
                    }
                }				 
                /*
                 * Sets color to red when nexthop-discard is increasing-at-least-by-value drop-threshold.
                 */				
                term is-nexthop-discard {
                    when {
                        increasing-at-least-by-value "$nexthop-discard" {
                            value "$drop-threshold";
                        }
                    }
                    then {
                        status {
                            color red;
                            message "Increasing nexthop-discard drop count $nexthop-discard at the rate $nexthop-discard-rate per minute";
                        }
                    }
                }
            }
            trigger pfe-stack-overflow-discard {
                synopsis "PFE stack overflow discards KPI";
                description "Sets health based on the change in PFE stack overflow discard count";
                frequency 1.25offset;
                /*
                 * Sets color to green when stack-overflow-discard is same as previous value.
                 */
                term no-stack-overflow-discard {
                    when {
                        matches-with-previous "$stack-overflow-discard";
                    }				
                    then {
                        status {
                            color green;
                            message "Stack-overflow-discard count $stack-overflow-discard";
                        }
                    }
                }				 
                /*
                 * Sets color to red when stack-overflow-discard is increasing-at-least-by-value drop-threshold.
                 */				
                term is-stack-overflow-discard {
                    when {
                        increasing-at-least-by-value "$stack-overflow-discard" {
                            value "$drop-threshold";
                        }
                    }
                    then {
                        status {
                            color red;
                            message "Increasing stack-overflow-discard drop count $stack-overflow-discard at the rate $stack-overflow-discard-rate per minute";
                        }
                    }
                }
            }
            trigger pfe-stack-underflow-discard {
                synopsis "PFE stack underflow discards KPI";
                description "Sets health based on the change in PFE stack underflow discard count";
                frequency 1.25offset;
                /*
                 * Sets color to green when stack-underflow-discard is same as previous value.
                 */
                term no-stack-underflow-discard {
                    when {
                        matches-with-previous "$stack-underflow-discard";
                    }				
                    then {
                        status {
                            color green;
                            message "Stack-underflow-discard count $stack-underflow-discard";
                        }
                    }
                }				 
                /*
                 * Sets color to red when stack-underflow-discard is increasing-at-least-by-value drop-threshold.
                 */				
                term is-stack-underflow-discard {
                    when {
                        increasing-at-least-by-value "$stack-underflow-discard" {
                            value "$drop-threshold";
                        }
                    }
                    then {
                        status {
                            color red;
                            message "Increasing stack-underflow-discard drop count $stack-underflow-discard at the rate $stack-underflow-discard-rate per minute";
                        }
                    }
                }
            }
            trigger pfe-tcp-header-error-discard {
                synopsis "PFE TCP header error discards KPI";
                description "Sets health based on the change in PFE TCP header error discard count";
                frequency 1.25offset;
                /*
                 * Sets color to green when tcp-header-error-discard is same as previous value.
                 */
                term no-tcp-header-error-discard {
                    when {
                        matches-with-previous "$tcp-header-error-discard";
                    }				
                    then {
                        status {
                            color green;
                            message "Tcp-header-error-discard count $tcp-header-error-discard";
                        }
                    }
                }				 
                /*
                 * Sets color to red when tcp-header-error-discard is increasing-at-least-by-value drop-threshold.
                 */				
                term is-tcp-header-error-discard {
                    when {
                        increasing-at-least-by-value "$tcp-header-error-discard" {
                            value "$drop-threshold";
                        }
                    }
                    then {
                        status {
                            color red;
                            message "Increasing tcp-header-error-discard drop count $tcp-header-error-discard at the rate $tcp-header-error-discard-rate per minute";
                        }
                    }
                }
            }
            variable discard-count {
                value 1;
                description "PFE discard threshold: Number of discards increase between metrics, before we report anomaly";
                type int;
            }
            rule-properties {
                version 1;
                contributor juniper;
                category advanced;
                supported-healthbot-version 4.2.0;
                supported-devices {
                    juniper {
                        operating-system junosEvolved {
                            products ACX {
                                platforms All {
                                    releases 22.3R1 {
                                        release-support min-supported-release;
                                    }
                                }
                            }
                        }						
                    }
                }
                helper-files other {
                    list-of-files evopfeDiscardStats.yml;
                }				
            }
        }
    }
}